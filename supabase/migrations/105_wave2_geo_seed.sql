-- 105_wave2_geo_seed.sql
-- Wave 2 geographic expansion: Lyon, Marseille, Lille × Plombier
-- Pattern: seed + enrich + activate (like 103+104 for Paris)
-- Per city: 200 providers, noindex=true default, 50 indexable (noindex=false)
-- stable_id: generated by trigger set_provider_stable_id (HMAC via generate_stable_id)
-- siren/siret: deterministic unique per city seed

-- ============================================================
-- 1. Ensure locations exist
-- ============================================================
INSERT INTO locations (id, name, slug, postal_code, department_code, department_name, region_code, region_name, latitude, longitude, population, is_active, created_at)
VALUES (
  'b0000000-0000-0000-0000-000000000002',
  'Lyon',
  'lyon',
  '69000',
  '69',
  'Rhône',
  '84',
  'Auvergne-Rhône-Alpes',
  45.7640,
  4.8357,
  522969,
  true,
  now()
)
ON CONFLICT (slug) DO NOTHING;

INSERT INTO locations (id, name, slug, postal_code, department_code, department_name, region_code, region_name, latitude, longitude, population, is_active, created_at)
VALUES (
  'b0000000-0000-0000-0000-000000000003',
  'Marseille',
  'marseille',
  '13000',
  '13',
  'Bouches-du-Rhône',
  '93',
  'Provence-Alpes-Côte d''Azur',
  43.2965,
  5.3698,
  870731,
  true,
  now()
)
ON CONFLICT (slug) DO NOTHING;

INSERT INTO locations (id, name, slug, postal_code, department_code, department_name, region_code, region_name, latitude, longitude, population, is_active, created_at)
VALUES (
  'b0000000-0000-0000-0000-000000000004',
  'Lille',
  'lille',
  '59000',
  '59',
  'Nord',
  '32',
  'Hauts-de-France',
  50.6292,
  3.0573,
  236234,
  true,
  now()
)
ON CONFLICT (slug) DO NOTHING;

-- ============================================================
-- 2. Seed 200 providers per city
--    stable_id: auto-generated by trigger_set_provider_stable_id
--    siren: {dept_code} + 7-digit index (9 digits total)
--    siret: siren + '00001' (14 digits total)
-- ============================================================

-- ----- LYON -----
DO $$
DECLARE
  existing_count INTEGER;
  i INTEGER;
  v_siren TEXT;
BEGIN
  SELECT count(*) INTO existing_count
  FROM providers
  WHERE specialty = 'Plombier' AND address_city = 'Lyon';

  IF existing_count < 200 THEN
    FOR i IN (existing_count + 1)..200 LOOP
      v_siren := '69' || lpad(i::text, 7, '0');

      INSERT INTO providers (
        id, name, slug, specialty,
        address_city, address_postal_code,
        siren, siret,
        is_active, is_verified, noindex,
        created_at, updated_at
      ) VALUES (
        gen_random_uuid(),
        'Plombier Lyon ' || i,
        'plombier-lyon-' || i,
        'Plombier',
        'Lyon',
        '69000',
        v_siren,
        v_siren || '00001',
        true,
        (i % 3 = 0),
        true,
        now(),
        now()
      );
    END LOOP;
  END IF;
END $$;

-- ----- MARSEILLE -----
DO $$
DECLARE
  existing_count INTEGER;
  i INTEGER;
  v_siren TEXT;
BEGIN
  SELECT count(*) INTO existing_count
  FROM providers
  WHERE specialty = 'Plombier' AND address_city = 'Marseille';

  IF existing_count < 200 THEN
    FOR i IN (existing_count + 1)..200 LOOP
      v_siren := '13' || lpad(i::text, 7, '0');

      INSERT INTO providers (
        id, name, slug, specialty,
        address_city, address_postal_code,
        siren, siret,
        is_active, is_verified, noindex,
        created_at, updated_at
      ) VALUES (
        gen_random_uuid(),
        'Plombier Marseille ' || i,
        'plombier-marseille-' || i,
        'Plombier',
        'Marseille',
        '13000',
        v_siren,
        v_siren || '00001',
        true,
        (i % 3 = 0),
        true,
        now(),
        now()
      );
    END LOOP;
  END IF;
END $$;

-- ----- LILLE -----
DO $$
DECLARE
  existing_count INTEGER;
  i INTEGER;
  v_siren TEXT;
BEGIN
  SELECT count(*) INTO existing_count
  FROM providers
  WHERE specialty = 'Plombier' AND address_city = 'Lille';

  IF existing_count < 200 THEN
    FOR i IN (existing_count + 1)..200 LOOP
      v_siren := '59' || lpad(i::text, 7, '0');

      INSERT INTO providers (
        id, name, slug, specialty,
        address_city, address_postal_code,
        siren, siret,
        is_active, is_verified, noindex,
        created_at, updated_at
      ) VALUES (
        gen_random_uuid(),
        'Plombier Lille ' || i,
        'plombier-lille-' || i,
        'Plombier',
        'Lille',
        '59000',
        v_siren,
        v_siren || '00001',
        true,
        (i % 3 = 0),
        true,
        now(),
        now()
      );
    END LOOP;
  END IF;
END $$;

-- ============================================================
-- 3. Enrich providers with realistic data per city
-- ============================================================

-- ----- LYON enrichment -----
DO $$
DECLARE
  r RECORD;
  idx INTEGER := 0;
  v_service_id UUID;
  v_location_id UUID;
  phones TEXT[] := ARRAY[
    '0472345601','0472345602','0472345603','0472345604','0472345605',
    '0678901201','0678901202','0678901203','0678901204','0678901205'
  ];
  quartiers TEXT[] := ARRAY[
    '69001','69002','69003','69004','69005','69006','69007','69008','69009'
  ];
  lats NUMERIC[] := ARRAY[
    45.767,45.757,45.760,45.743,45.753,45.763,45.738,45.736,45.779
  ];
  lngs NUMERIC[] := ARRAY[
    4.834,4.833,4.844,4.827,4.824,4.849,4.840,4.870,4.847
  ];
BEGIN
  SELECT id INTO v_service_id FROM services WHERE slug = 'plombier' LIMIT 1;
  SELECT id INTO v_location_id FROM locations WHERE slug = 'lyon' LIMIT 1;

  FOR r IN
    SELECT id, name FROM providers
    WHERE specialty = 'Plombier' AND address_city = 'Lyon'
    ORDER BY name
  LOOP
    idx := idx + 1;

    UPDATE providers SET
      phone = phones[1 + (idx % 10)],
      address_postal_code = quartiers[1 + (idx % 9)],
      latitude = lats[1 + (idx % 9)] + (random() * 0.008 - 0.004),
      longitude = lngs[1 + (idx % 9)] + (random() * 0.008 - 0.004),
      rating_average = CASE
        WHEN idx % 5 = 0 THEN NULL
        ELSE round((3.5 + random() * 1.5)::numeric, 1)
      END,
      review_count = CASE
        WHEN idx % 5 = 0 THEN 0
        ELSE floor(random() * 50 + 1)::integer
      END,
      experience_years = CASE
        WHEN idx % 4 = 0 THEN NULL
        ELSE floor(random() * 25 + 1)::integer
      END,
      description = 'Plombier professionnel à Lyon ' || quartiers[1 + (idx % 9)]
        || '. Interventions rapides : dépannage, installation sanitaire, chauffage, débouchage.'
        || ' Devis gratuit et sans engagement.',
      updated_at = now()
    WHERE id = r.id;

    IF v_service_id IS NOT NULL THEN
      INSERT INTO provider_services (id, provider_id, service_id, is_primary, created_at)
      VALUES (gen_random_uuid(), r.id, v_service_id, true, now())
      ON CONFLICT DO NOTHING;
    END IF;

    IF v_location_id IS NOT NULL THEN
      INSERT INTO provider_locations (id, provider_id, location_id, is_primary, created_at)
      VALUES (gen_random_uuid(), r.id, v_location_id, true, now())
      ON CONFLICT DO NOTHING;
    END IF;
  END LOOP;
END $$;

-- ----- MARSEILLE enrichment -----
DO $$
DECLARE
  r RECORD;
  idx INTEGER := 0;
  v_service_id UUID;
  v_location_id UUID;
  phones TEXT[] := ARRAY[
    '0491234501','0491234502','0491234503','0491234504','0491234505',
    '0634567801','0634567802','0634567803','0634567804','0634567805'
  ];
  arrondissements TEXT[] := ARRAY[
    '13001','13002','13003','13004','13005','13006','13007','13008',
    '13009','13010','13011','13012','13013','13014','13015','13016'
  ];
  lats NUMERIC[] := ARRAY[
    43.296,43.296,43.303,43.298,43.291,43.286,43.290,43.273,
    43.252,43.282,43.299,43.313,43.332,43.323,43.345,43.363
  ];
  lngs NUMERIC[] := ARRAY[
    5.374,5.366,5.383,5.395,5.396,5.380,5.362,5.372,
    5.412,5.405,5.435,5.437,5.418,5.388,5.360,5.323
  ];
BEGIN
  SELECT id INTO v_service_id FROM services WHERE slug = 'plombier' LIMIT 1;
  SELECT id INTO v_location_id FROM locations WHERE slug = 'marseille' LIMIT 1;

  FOR r IN
    SELECT id, name FROM providers
    WHERE specialty = 'Plombier' AND address_city = 'Marseille'
    ORDER BY name
  LOOP
    idx := idx + 1;

    UPDATE providers SET
      phone = phones[1 + (idx % 10)],
      address_postal_code = arrondissements[1 + (idx % 16)],
      latitude = lats[1 + (idx % 16)] + (random() * 0.008 - 0.004),
      longitude = lngs[1 + (idx % 16)] + (random() * 0.008 - 0.004),
      rating_average = CASE
        WHEN idx % 5 = 0 THEN NULL
        ELSE round((3.5 + random() * 1.5)::numeric, 1)
      END,
      review_count = CASE
        WHEN idx % 5 = 0 THEN 0
        ELSE floor(random() * 50 + 1)::integer
      END,
      experience_years = CASE
        WHEN idx % 4 = 0 THEN NULL
        ELSE floor(random() * 25 + 1)::integer
      END,
      description = 'Plombier professionnel à Marseille ' || arrondissements[1 + (idx % 16)]
        || '. Interventions rapides : dépannage, installation sanitaire, chauffage, débouchage.'
        || ' Devis gratuit et sans engagement.',
      updated_at = now()
    WHERE id = r.id;

    IF v_service_id IS NOT NULL THEN
      INSERT INTO provider_services (id, provider_id, service_id, is_primary, created_at)
      VALUES (gen_random_uuid(), r.id, v_service_id, true, now())
      ON CONFLICT DO NOTHING;
    END IF;

    IF v_location_id IS NOT NULL THEN
      INSERT INTO provider_locations (id, provider_id, location_id, is_primary, created_at)
      VALUES (gen_random_uuid(), r.id, v_location_id, true, now())
      ON CONFLICT DO NOTHING;
    END IF;
  END LOOP;
END $$;

-- ----- LILLE enrichment -----
DO $$
DECLARE
  r RECORD;
  idx INTEGER := 0;
  v_service_id UUID;
  v_location_id UUID;
  phones TEXT[] := ARRAY[
    '0320456701','0320456702','0320456703','0320456704','0320456705',
    '0656789001','0656789002','0656789003','0656789004','0656789005'
  ];
  quartiers TEXT[] := ARRAY[
    '59000','59800','59260','59160','59130','59100','59110','59120'
  ];
  lats NUMERIC[] := ARRAY[
    50.629,50.615,50.653,50.644,50.625,50.608,50.614,50.638
  ];
  lngs NUMERIC[] := ARRAY[
    3.057,3.059,3.088,3.044,3.031,3.070,3.103,3.084
  ];
BEGIN
  SELECT id INTO v_service_id FROM services WHERE slug = 'plombier' LIMIT 1;
  SELECT id INTO v_location_id FROM locations WHERE slug = 'lille' LIMIT 1;

  FOR r IN
    SELECT id, name FROM providers
    WHERE specialty = 'Plombier' AND address_city = 'Lille'
    ORDER BY name
  LOOP
    idx := idx + 1;

    UPDATE providers SET
      phone = phones[1 + (idx % 10)],
      address_postal_code = quartiers[1 + (idx % 8)],
      latitude = lats[1 + (idx % 8)] + (random() * 0.008 - 0.004),
      longitude = lngs[1 + (idx % 8)] + (random() * 0.008 - 0.004),
      rating_average = CASE
        WHEN idx % 5 = 0 THEN NULL
        ELSE round((3.5 + random() * 1.5)::numeric, 1)
      END,
      review_count = CASE
        WHEN idx % 5 = 0 THEN 0
        ELSE floor(random() * 50 + 1)::integer
      END,
      experience_years = CASE
        WHEN idx % 4 = 0 THEN NULL
        ELSE floor(random() * 25 + 1)::integer
      END,
      description = 'Plombier professionnel à Lille ' || quartiers[1 + (idx % 8)]
        || '. Interventions rapides : dépannage, installation sanitaire, chauffage, débouchage.'
        || ' Devis gratuit et sans engagement.',
      updated_at = now()
    WHERE id = r.id;

    IF v_service_id IS NOT NULL THEN
      INSERT INTO provider_services (id, provider_id, service_id, is_primary, created_at)
      VALUES (gen_random_uuid(), r.id, v_service_id, true, now())
      ON CONFLICT DO NOTHING;
    END IF;

    IF v_location_id IS NOT NULL THEN
      INSERT INTO provider_locations (id, provider_id, location_id, is_primary, created_at)
      VALUES (gen_random_uuid(), r.id, v_location_id, true, now())
      ON CONFLICT DO NOTHING;
    END IF;
  END LOOP;
END $$;

-- ============================================================
-- 4. Activate up to 50 providers per city (noindex = false)
-- ============================================================

-- Lyon: 50 indexable
UPDATE providers SET noindex = false
WHERE id IN (
  SELECT id FROM providers
  WHERE specialty = 'Plombier' AND address_city = 'Lyon' AND is_verified = true
  ORDER BY name
  LIMIT 50
);

-- Marseille: 50 indexable
UPDATE providers SET noindex = false
WHERE id IN (
  SELECT id FROM providers
  WHERE specialty = 'Plombier' AND address_city = 'Marseille' AND is_verified = true
  ORDER BY name
  LIMIT 50
);

-- Lille: 50 indexable
UPDATE providers SET noindex = false
WHERE id IN (
  SELECT id FROM providers
  WHERE specialty = 'Plombier' AND address_city = 'Lille' AND is_verified = true
  ORDER BY name
  LIMIT 50
);
